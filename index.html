<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Sake Table - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Smart Sake Table: zones, notes, CSV previews, and quick links.">
  <link rel="stylesheet" href="styles.css">

  <!-- Chart.js for quick visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Minimal helpers (won’t fight your styles.css) */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    .row { display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; }
    .btn {
      display:inline-block; padding:.55rem .85rem; border-radius:.6rem;
      text-decoration:none; background:#0ea5e9; color:#fff; font-weight:600;
    }
    .btn.sec { background:#334155; }
    .card {
      background:#fff; border-radius:1rem; padding:1rem; margin:1rem 0;
      box-shadow:0 6px 18px rgba(2,8,23,.06);
    }
    .grid { display:grid; gap:1rem; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); }
    .small { font-size:.9rem; color:#475569; }
    table { width:100%; border-collapse: collapse; font-size:.9rem; }
    th, td { border-top:1px solid #e2e8f0; padding:.5rem .4rem; text-align:left; }
    th { background:#f8fafc; }
    .error { color:#b91c1c; font-weight:600; }
    .zones { margin-top:.5rem; }
    .zones .zone { margin:.25rem; }
    canvas { width:100%; height:340px; }
  </style>
</head>
<body>
  <header>
    <h1>Home</h1>
  </header>

  <main>
    <div class="stage">
      <section class="layout">
        <!-- Quick links to your dashboards -->
        <nav class="wrap row" aria-label="Primary navigation">
          <a class="btn" href="html%20dashboard.html">Open Dashboard</a>
          <a class="btn sec" href="html%20dashboard%20ai.html">Open AI Dashboard</a>
          <a class="btn" href="https://github.com/bean-lin/SmartSakeTableClone" target="_blank" rel="noopener">GitHub Repo</a>
        </nav>

        <!-- Zones (kept from your layout) -->
        <section class="zones" aria-label="Zones">
          <a class="zone" href="zone1.html" role="button" aria-label="Zone 1">Zone 1</a>
          <a class="zone" href="zone2.html" role="button" aria-label="Zone 2">Zone 2</a>
          <a class="zone" href="zone3.html" role="button" aria-label="Zone 3">Zone 3</a>
          <a class="zone" href="zone4.html" role="button" aria-label="Zone 4">Zone 4</a>
          <a class="zone" href="zone5.html" role="button" aria-label="Zone 5">Zone 5</a>
          <a class="zone" href="zone6.html" role="button" aria-label="Zone 6">Zone 6</a>
        </section>

        <!-- Notes (kept from your layout) -->
        <div class="notes-wrap">
          <div class="notes__meta" id="notes-meta" aria-live="polite">Date, Time</div>
          <div class="notes" aria-label="Notes">
            <label class="sr-only" for="notes-input">Notes</label>
            <textarea id="notes-input" class="notes__input" placeholder="Enter notes..." aria-label="Notes input"></textarea>
          </div>
        </div>

        <div class="left">
          <div class="long long--top-left">Temperature over time</div>
          <div class="long long--top-left">Humidity over time</div>
          <div class="long long--top-left">Fans on/off over time</div>
        </div>
      </section>

      <!-- New: CSV previews & quick chart -->
      <section class="wrap" aria-label="Data previews">

        <div class="grid">
          <!-- Temperature readings preview + chart -->
          <article class="card">
            <h2 style="margin:.2rem 0 .6rem">Temperature Readings (data/temperature_readings.csv)</h2>
            <div id="temp-table-wrap" class="small">Loading preview…</div>
            <div style="margin-top:.75rem">
              <canvas id="tempChart" aria-label="Temperature chart" role="img"></canvas>
              <div class="small" id="tempChart-note"></div>
            </div>
          </article>

          <!-- Target temperatures preview -->
          <article class="card">
            <h2 style="margin:.2rem 0 .6rem">Target Temperatures (data/sample_target_temperatures.csv)</h2>
            <div id="target-table-wrap" class="small">Loading preview…</div>
          </article>
        </div>

        <p class="small">Tip: Keep CSV headers simple (e.g., <code>timestamp,zone,temperature</code>). The chart will auto-use a
          <code>timestamp</code>/<code>time</code> column for X and a numeric column (e.g., <code>temperature</code>) for Y.</p>
      </section>

      <!-- Temperature row (kept from your layout) -->
      <section class="temp-row" aria-label="Temperature readings">
        <div class="temp">
          <span class="temp__label">Temp 1</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
        <div class="temp">
          <span class="temp__label">Temp 2</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
        <div class="temp">
          <span class="temp__label">Temp 3</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
        <div class="temp">
          <span class="temp__label">Temp 4</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
        <div class="temp">
          <span class="temp__label">Temp 5</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
        <div class="temp">
          <span class="temp__label">Temp 6</span>
          <span class="temp__value"><span class="temp__num">XX</span><span class="temp__unit"> °F</span></span>
        </div>
      </section>
    </div>
  </main>

  <!-- Live Date/Time script -->
  <script>
  (function(){
    const el = document.getElementById('notes-meta');
    if(!el) return;
    function formatNow(d){
      const date = d.toLocaleDateString(undefined,{ month:'short', day:'numeric', year:'numeric' });
      const time = d.toLocaleTimeString(undefined,{ hour:'2-digit', minute:'2-digit' });
      return date + ' — ' + time;
    }
    function update(){ el.textContent = formatNow(new Date()); }
    update();
    const msToNext = 60000 - (Date.now() % 60000);
    let timer = setTimeout(function(){ update(); timer = setInterval(update, 60000); }, msToNext);
    document.addEventListener('visibilitychange', function(){ if(document.visibilityState === 'visible') update(); });
  })();
  </script>

  <!-- CSV preview + auto chart -->
  <script>
  // Lightweight CSV parser (no dependencies)
  function parseCSV(text) {
    // Simple split; handles quoted commas minimally
    const lines = text.trim().split(/\r?\n/);
    if (!lines.length) return { headers: [], rows: [] };

    const headers = splitCSVLine(lines[0]);
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cells = splitCSVLine(lines[i]);
      const row = {};
      headers.forEach((h, idx) => row[h] = cells[idx] ?? "");
      rows.push(row);
    }
    return { headers, rows };

    function splitCSVLine(line) {
      const out = [];
      let cur = "", inQ = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur += '"'; i++; } else { inQ = !inQ; }
        } else if (ch === ',' && !inQ) {
          out.push(cur); cur = "";
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(s => s.trim());
    }
  }

  function buildTable(container, headers, rows, opts = {}) {
    const limit = opts.limit ?? 10;
    if (!headers.length || !rows.length) {
      container.innerHTML = '<span class="error">No data</span>';
      return;
    }
    const tbl = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    headers.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
    thead.appendChild(trh);
    tbl.appendChild(thead);

    const tbody = document.createElement('tbody');
    const start = Math.max(0, rows.length - limit);
    for (let i = start; i < rows.length; i++) {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = rows[i][h] ?? "";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
    tbl.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(tbl);
    const note = document.createElement('div');
    note.className = 'small';
    note.textContent = `Showing last ${rows.length - start} of ${rows.length} rows`;
    container.appendChild(note);
  }

  function detectColumns(headers, rows) {
    // Prefer common time headers
    const timeCandidates = ['timestamp','time','date','datetime'];
    let timeKey = headers.find(h => timeCandidates.includes(h.toLowerCase()));
    // Find first numeric column from the bottom row
    let numKey = null;
    if (rows.length) {
      const last = rows[rows.length - 1];
      for (const h of headers) {
        const v = parseFloat(String(last[h]).replace(/[^0-9.\-eE]/g,''));
        if (!Number.isNaN(v)) { numKey = h; break; }
      }
    }
    // Prefer temperature column name if present
    const tempPref = headers.find(h => /temp/gi.test(h));
    if (tempPref) numKey = tempPref;
    return { timeKey, numKey };
  }

  function toDate(val) {
    // Accept ISO, or numeric epoch
    if (val == null) return null;
    const s = String(val).trim();
    if (!s) return null;
    const n = Number(s);
    if (!Number.isNaN(n) && s.length >= 10) { // maybe epoch seconds/ms
      return new Date(n > 1e12 ? n : n*1000);
    }
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  async function loadAndPreviewCSV(path, tableContainerId) {
    const container = document.getElementById(tableContainerId);
    try {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const txt = await res.text();
      const { headers, rows } = parseCSV(txt);
      buildTable(container, headers, rows, { limit: 10 });
      return { headers, rows };
    } catch (e) {
      container.innerHTML = `<span class="error">Failed to load ${path}: ${e.message}</span>`;
      return { headers: [], rows: [] };
    }
  }

  function makeLineChart(canvasId, labels, values, labelText) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return null;
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{ label: labelText, data: values, borderWidth: 2, tension: .2, pointRadius: 0 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 6 }}, y: { beginAtZero: false } },
        plugins: { legend: { display: true } }
      }
    });
  }

  (async function init() {
    // Previews
    const tempData = await loadAndPreviewCSV('data/temperature_readings.csv', 'temp-table-wrap');
    await loadAndPreviewCSV('data/sample_target_temperatures.csv', 'target-table-wrap');

    // Chart (auto-detect time & numeric)
    const note = document.getElementById('tempChart-note');
    if (!tempData.rows.length) {
      note.textContent = 'No rows to chart.';
      return;
    }
    const { headers, rows } = tempData;
    const { timeKey, numKey } = detectColumns(headers, rows);

    if (!numKey) {
      note.innerHTML = '<span class="error">Could not find a numeric column to chart.</span>';
      return;
    }

    // Build labels: prefer time; else use row index
    let labels = [];
    if (timeKey) {
      labels = rows.map(r => {
        const d = toDate(r[timeKey]);
        return d ? d.toLocaleString() : String(r[timeKey] ?? '');
      });
    } else {
      labels = rows.map((_, i) => String(i + 1));
    }

    // Values
    const values = rows.map(r => {
      const s = String(r[numKey] ?? '').replace(/[^0-9.\-eE]/g,'');
      const v = parseFloat(s);
      return Number.isNaN(v) ? null : v;
    });

    makeLineChart('tempChart', labels.slice(-100), values.slice(-100), numKey);
    note.textContent = timeKey
      ? `Charting "${numKey}" over "${timeKey}" (last ${Math.min(100, rows.length)} rows)`
      : `Charting "${numKey}" vs. row index (last ${Math.min(100, rows.length)} rows)`;
  })();
  </script>
</body>
</html>
